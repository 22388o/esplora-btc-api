name: crates

on:
    push:
        tags:
            - "*"

jobs:
    publish:
        runs-on: [self-hosted, linux]
        steps:
            - uses: actions/checkout@v2

            - name: setup node
              uses: actions/setup-node@v2
              with:
                  node-version: "14.x"
                  registry-url: "https://registry.npmjs.org"
                  always-auth: true

            - name: setup java
              uses: actions/setup-java@v2
              with:
                  distribution: 'zulu'
                  java-version: '11'

            - uses: actions-rs/toolchain@v1
              with:
                toolchain: stable
                profile: minimal
                override: true

            - run: cargo install cargo-release

            - name: Run openapi-generator
              run: |
                npx @openapitools/openapi-generator-cli generate \
                  --generator-name rust \
                  --config rust-openapi-config.json \
                  --input-spec api.yaml \
                  --output rust-client

            - run: |
                cargo-release release \
                  --token ${CARGO_AUTH_TOKEN} \
                  --tag-name "v{{version}}" \
                  --skip-push \
                  --skip-tag \
                  --no-dev-version \
                  --no-confirm \
                  --execute \
                  ${GITHUB_REF:10}
              env:
                  CARGO_AUTH_TOKEN: ${{ secrets.CARGO_AUTH_TOKEN }}
              working-directory: rust-client